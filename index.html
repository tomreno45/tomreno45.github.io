<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WFL Team Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* Loading overlay */
        .db-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 60, 114, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .db-loading-overlay.hidden { display: none; }
        .db-loading-content { text-align: center; color: white; }
        .db-loading-content h2 { font-size: 2em; margin-bottom: 20px; }
        .db-loading-spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }
        .tab-button {
            flex: 1;
            min-width: 100px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid transparent;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .tab-button:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
        .tab-button.active { background: white; color: #1e3c72; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Controls */
        .controls {
            background: white;
            padding: 20px 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .control-group {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        label { font-weight: 600; color: #333; font-size: 16px; }
        select {
            flex: 1;
            min-width: 180px;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
        }
        button {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
        }
        button:hover { background: #2a5298; }

        .loading { text-align: center; padding: 40px; color: white; font-size: 18px; }
        .error { background: #ff6b6b; color: white; padding: 16px 20px; border-radius: 10px; margin-bottom: 20px; }

        /* Team header */
        .team-header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white; padding: 22px 28px;
            border-radius: 15px; margin-bottom: 20px;
        }
        .team-header h2 { font-size: 2em; margin-bottom: 4px; }
        .team-header-logo { display: flex; align-items: center; gap: 15px; }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white; padding: 18px;
            border-radius: 10px; text-align: center;
        }
        .stat-label { font-size: 12px; opacity: 0.9; text-transform: uppercase; }
        .stat-value { font-size: 34px; font-weight: bold; margin-top: 6px; }

        /* Player cards - horizontal */
        .roster-container {
            background: white; border-radius: 15px;
            padding: 28px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .position-group { margin-bottom: 28px; }
        .position-header {
            background: #f5f5f5; padding: 10px 18px;
            border-radius: 8px; margin-bottom: 14px;
            font-weight: 600; color: #333; font-size: 17px;
            border-left: 4px solid #1e3c72;
        }
        .player-grid { display: flex; flex-direction: column; gap: 10px; }
        .player-card {
            background: white; border: 2px solid #e0e0e0;
            border-radius: 8px; padding: 12px 16px;
            display: grid;
            grid-template-columns: auto 1fr auto auto auto auto auto auto auto auto;
            gap: 20px;
            align-items: center;
        }
        .player-card.injured { border-color: #e74c3c; background: #fff5f5; }
        .player-card:hover { border-color: #1e3c72; transform: translateX(4px); }
        .player-card.injured:hover { border-color: #e74c3c; }
        .depth-badge { background: #1e3c72; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .injury-badge {
            background: #e74c3c;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .injury-type {
            font-weight: 700;
            text-transform: uppercase;
        }
        .injury-weeks {
            font-size: 9px;
            opacity: 0.9;
        }
        .player-name { font-size: 16px; font-weight: 700; color: #1e3c72; }
        .player-detail { font-size: 14px; display: flex; flex-direction: column; align-items: center; }
        .player-detail-label { font-size: 10px; color: #888; text-transform: uppercase; }
        .player-detail-value { font-weight: 600; color: #333; }
        .player-stat-inline { text-align: center; display: flex; flex-direction: column; }
        .stat-name-inline { font-size: 10px; color: #888; text-transform: uppercase; }
        .stat-val-inline { font-size: 18px; font-weight: bold; color: #1e3c72; }

        /* Tables */
        .standings-table-container, .scores-table-container, .stats-table-container {
            background: white; border-radius: 15px;
            padding: 28px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #1e3c72; color: white; }
        th { padding: 13px 14px; text-align: left; font-size: 12px; text-transform: uppercase; }
        td { padding: 11px 14px; border-bottom: 1px solid #e0e0e0; }
        tbody tr:hover { background: #f8f9ff; }
        .rank-badge { display: inline-flex; width: 28px; height: 28px; border-radius: 50%; background: #1e3c72; color: white; font-weight: bold; align-items: center; justify-content: center; }
        .rank-1 { background: #f1c40f; color: #333; }
        .rank-2 { background: #95a5a6; }
        .rank-3 { background: #cd7f32; }
        .team-logo { width: 40px; height: 40px; object-fit: contain; margin-right: 8px; }
        .team-logo-small { width: 30px; height: 30px; object-fit: contain; margin-right: 6px; }
        .team-logo-large { width: 60px; height: 60px; object-fit: contain; }
        .team-with-logo { display: flex; align-items: center; gap: 8px; }

        /* Game cards */
        .game-card {
            background: white; border: 2px solid #e0e0e0;
            border-radius: 10px; padding: 18px; margin-bottom: 14px;
        }
        .game-card:hover { border-color: #1e3c72; }
        .game-header { display: flex; justify-content: space-between; margin-bottom: 14px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .game-teams { display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; }
        .game-team-container { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .team-name { font-size: 17px; font-weight: 700; color: #1e3c72; }
        .team-name.winner { color: #2ecc71; }
        .score { font-size: 30px; font-weight: bold; color: #333; }
        .score.winner { color: #2ecc71; }
        .vs { font-size: 13px; color: #999; font-weight: 600; }
        .game-badge { padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; margin-left: 8px; }
        .badge-tie { background: #f39c12; color: white; }
        .badge-ot { background: #e74c3c; color: white; }

        /* News feed */
        .news-feed { max-width: 620px; margin: 0 auto; }
        .news-card { background: #fff; border: 1px solid #e2e8f0; padding: 16px 20px; }
        .news-feed .news-card:first-child { border-radius: 16px 16px 0 0; }
        .news-feed .news-card:last-child { border-radius: 0 0 16px 16px; }
        .news-feed .news-card:only-child { border-radius: 16px; }
        .news-card + .news-card { border-top: none; }
        .news-card:hover { background: #f7fafc; }
        .news-card-inner { display: grid; grid-template-columns: 48px 1fr; gap: 12px; }
        .news-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        .news-avatar-placeholder {
            width: 48px; height: 48px; border-radius: 50%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 18px;
        }
        .news-header { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 4px; }
        .news-name { font-weight: 700; color: #0f172a; font-size: 15px; }
        .news-handle { color: #64748b; font-size: 14px; }
        .news-meta { color: #94a3b8; font-size: 13px; margin-left: auto; }
        .news-content { font-size: 15px; line-height: 1.6; color: #1e293b; white-space: pre-wrap; margin-bottom: 10px; }
        .news-image { width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 10px; }
        .news-footer { display: flex; gap: 22px; margin-top: 12px; color: #64748b; font-size: 13px; }
        .news-badge { padding: 2px 9px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge-report { background: #dbeafe; color: #1d4ed8; }
        .badge-tweet { background: #e0f2fe; color: #0369a1; }
        .badge-injury { background: #fee2e2; color: #dc2626; }
        .badge-trade { background: #dcfce7; color: #15803d; }
        .badge-default { background: #f1f5f9; color: #475569; }
        .empty-state { text-align: center; padding: 50px 20px; color: #999; }

        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .player-card { grid-template-columns: auto 1fr; gap: 12px 16px; }
        }
    </style>
</head>
<body>
<div class="db-loading-overlay" id="dbLoading">
    <div class="db-loading-content">
        <h2>üèà Loading WFL Database...</h2>
        <div class="db-loading-spinner"></div>
        <p>Please wait while we load your team data</p>
    </div>
</div>

<div class="container">
    <h1>üèà WFL Team Manager</h1>

    <div class="tabs">
        <button class="tab-button active" onclick="switchTab('roster')">Roster</button>
        <button class="tab-button" onclick="switchTab('standings')">Standings</button>
        <button class="tab-button" onclick="switchTab('scores')">Scores</button>
        <button class="tab-button" onclick="switchTab('stats')">Season Stats</button>
        <button class="tab-button" onclick="switchTab('news')">WFL News</button>
    </div>

    <div id="roster-tab" class="tab-content active">
        <div class="controls">
            <div class="control-group">
                <label for="teamSelect">Select Team:</label>
                <select id="teamSelect"><option value="">-- Choose a team --</option></select>
                <button onclick="clearRoster()">Clear</button>
            </div>
        </div>
        <div id="roster-error"></div>
        <div id="team-header"></div>
        <div id="stats-container"></div>
        <div id="roster-container">
            <div class="roster-container"><div class="empty-state"><h3>No team selected</h3></div></div>
        </div>
    </div>

    <div id="standings-tab" class="tab-content">
        <div class="controls">
            <div class="control-group">
                <h2 style="color:#333;margin:0;">Team Standings</h2>
                <button onclick="loadStandings()">üîÑ Refresh</button>
            </div>
        </div>
        <div id="standings-container"></div>
    </div>

    <div id="scores-tab" class="tab-content">
        <div class="controls">
            <div class="control-group">
                <h2 style="color:#333;margin:0;">Game Scores</h2>
                <button onclick="loadScores()">üîÑ Refresh</button>
            </div>
        </div>
        <div id="scores-container"></div>
    </div>

    <div id="stats-tab" class="tab-content">
        <div class="controls">
            <div class="control-group">
                <label for="skillSelect">Skill Category:</label>
                <select id="skillSelect" onchange="filterStatsBySkill()">
                    <option value="passing">Passing</option>
                    <option value="rushing">Rushing</option>
                    <option value="receiving">Receiving</option>
                    <option value="defense">Defense</option>
                    <option value="kicking">Kicking</option>
                    <option value="punting">Punting</option>
                </select>
                <label for="sortSelect">Sort By:</label>
                <select id="sortSelect" onchange="filterStatsBySkill()"><option value="">-- Choose stat --</option></select>
                <button id="sortOrderBtn" onclick="toggleSortOrder()">‚Üì Desc</button>
                <button onclick="loadSeasonStats()">üîÑ Refresh</button>
            </div>
        </div>
        <div id="season-stats-container"></div>
    </div>

    <div id="news-tab" class="tab-content">
        <div class="controls">
            <div class="control-group">
                <label for="newsFilter">Filter:</label>
                <select id="newsFilter" onchange="filterNews()">
                    <option value="all">All News</option>
                    <option value="report">Reports</option>
                    <option value="tweet">Tweets</option>
                    <option value="injury">Injuries</option>
                    <option value="trade">Trades</option>
                </select>
                <button onclick="loadNews()">üîÑ Refresh</button>
            </div>
        </div>
        <div id="news-container"></div>
    </div>
</div>

<!-- Load SQL.js from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

<script>
    let db = null;
    let allSeasonStats = [];
    let allNews = [];
    let sortOrder = 'desc';

    // ‚îÄ‚îÄ Initialize database ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function initDatabase() {
        try {
            const SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });

            const response = await fetch('GameTest.db');
            if (!response.ok) throw new Error('Database file not found');
            
            const buffer = await response.arrayBuffer();
            db = new SQL.Database(new Uint8Array(buffer));

            document.getElementById('dbLoading').classList.add('hidden');
            loadTeams();
        } catch (error) {
            document.getElementById('dbLoading').innerHTML = 
                '<div class="db-loading-content"><h2>‚ùå Error Loading Database</h2><p>' + error.message + '</p><p>Make sure GameTest.db is in the same folder as index.html</p></div>';
        }
    }

    // Helper to run SQL queries
    function query(sql, params = []) {
        const stmt = db.prepare(sql);
        if (params.length) stmt.bind(params);
        const rows = [];
        while (stmt.step()) {
            const row = stmt.getAsObject();
            rows.push(row);
        }
        stmt.free();
        return rows;
    }

    // ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function switchTab(name) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
        document.getElementById(name + '-tab').classList.add('active');
        document.querySelectorAll('.tab-button').forEach(btn => {
            if (btn.getAttribute('onclick') === "switchTab('" + name + "')") btn.classList.add('active');
        });
        if (name === 'standings') loadStandings();
        else if (name === 'scores') loadScores();
        else if (name === 'stats') loadSeasonStats();
        else if (name === 'news') loadNews();
    }

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function logoImg(teamName, cls) {
        if (!teamName) return '';
        return '<img src="Pictures/' + teamName + '.png" alt="' + teamName + '" class="' + (cls||'team-logo') + '" onerror="this.onerror=null; this.src=\'pictures/' + teamName + '.png\'; this.onerror=function(){this.style.display=\'none\'}">';
    }
    function fmtHeight(inches) { return Math.floor(inches/12) + "'" + (inches%12) + '"'; }
    function getInitials(name) {
        if (!name) return '?';
        return name.trim().split(/\s+/).map(w => w[0].toUpperCase()).slice(0,2).join('');
    }
    function posName(pos) {
        const map = {QB:'Quarterback',WR:'Wide Receiver',RB:'Running Back',TE:'Tight End',
                     OL:'Offensive Line',DE:'Defensive End',DT:'Defensive Tackle',
                     LB:'Linebacker',CB:'Cornerback',FS:'Free Safety',SS:'Strong Safety',
                     K:'Kicker',P:'Punter'};
        return map[pos] || pos;
    }

    // ‚îÄ‚îÄ Teams / Roster ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loadTeams() {
        const teams = query('SELECT TeamID, name, nickname, owner FROM Teams ORDER BY name');
        const sel = document.getElementById('teamSelect');
        teams.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.TeamID;
            opt.textContent = t.name + (t.owner ? ' (Owner: ' + t.owner + ')' : '');
            sel.appendChild(opt);
        });
        sel.addEventListener('change', onTeamChange);
    }

    function onTeamChange(e) {
        const id = e.target.value;
        if (!id) { clearRoster(); return; }
        const team = query('SELECT * FROM Teams WHERE TeamID = ?', [id])[0];
        
        // Get current league state
        const leagueState = query('SELECT Season, Week FROM LeagueState LIMIT 1')[0];
        const currentSeason = leagueState ? leagueState.Season : 2025;
        const currentWeek = leagueState ? leagueState.Week : 1;
        
        const roster = query(`
            SELECT r.PlayerID, r.Pos, r.DepthChart,
                   p.FirstName, p.LastName, p.Age, p.Height, p.Weight, p.College,
                   pa.overall, pa.overall_let, pa.potential, pa.potential_let,
                   i.InjuryType, i.WeekStart, i.WeekEnd
            FROM Rosters r
            LEFT JOIN Players p ON r.PlayerID = p.PlayerID
            LEFT JOIN PlayerAttributes pa ON r.PlayerID = pa.PlayerID
            LEFT JOIN InjuryLog i ON r.PlayerID = i.PlayerID 
                AND i.Season = ? 
                AND i.WeekStart <= ? 
                AND i.WeekEnd >= ?
            WHERE r.TeamID = ?
            ORDER BY CASE r.Pos
                WHEN 'QB' THEN 1 WHEN 'WR' THEN 2 WHEN 'RB' THEN 3 WHEN 'TE' THEN 4 WHEN 'OL' THEN 5
                WHEN 'DE' THEN 6 WHEN 'DT' THEN 7 WHEN 'LB' THEN 8 WHEN 'CB' THEN 9 WHEN 'FS' THEN 10
                WHEN 'SS' THEN 11 WHEN 'K' THEN 12 WHEN 'P' THEN 13 ELSE 14 END, r.DepthChart
        `, [currentSeason, currentWeek, currentWeek, id]);
        renderTeamHeader(team);
        renderRosterStats(roster);
        renderRoster(roster);
    }

    function renderTeamHeader(team) {
        document.getElementById('team-header').innerHTML =
            '<div class="team-header"><div class="team-header-logo">' +
            logoImg(team.name, 'team-logo-large') +
            '<div><h2>' + team.name + '</h2>' +
            (team.owner ? '<div style="opacity:0.9">Owner: ' + team.owner + '</div>' : '') +
            '</div></div></div>';
    }

    function renderRosterStats(roster) {
        if (!roster.length) { document.getElementById('stats-container').innerHTML = ''; return; }
        const rated = roster.filter(p => p.overall);
        const avg = rated.length ? (rated.reduce((s,p) => s + p.overall, 0) / rated.length).toFixed(0) : 'N/A';
        document.getElementById('stats-container').innerHTML =
            '<div class="stats">' +
            '<div class="stat-card"><div class="stat-label">Total Players</div><div class="stat-value">' + roster.length + '</div></div>' +
            '<div class="stat-card"><div class="stat-label">Avg Overall</div><div class="stat-value">' + avg + '</div></div>' +
            '</div>';
    }

    function renderRoster(roster) {
        if (!roster.length) {
            document.getElementById('roster-container').innerHTML =
                '<div class="roster-container"><div class="empty-state"><h3>No players found</h3></div></div>';
            return;
        }
        const groups = {};
        roster.forEach(p => { (groups[p.Pos] = groups[p.Pos] || []).push(p); });
        const order = ['QB','WR','RB','TE','OL','DE','DT','LB','CB','FS','SS','K','P'];
        
        // Get current week for injury calculation
        const leagueState = query('SELECT Week FROM LeagueState LIMIT 1')[0];
        const currentWeek = leagueState ? leagueState.Week : 1;
        
        let html = '<div class="roster-container">';
        order.forEach(pos => {
            if (!groups[pos]) return;
            html += '<div class="position-group"><div class="position-header">' +
                    posName(pos) + ' (' + groups[pos].length + ')</div><div class="player-grid">';
            groups[pos].forEach(p => {
                const ovr = p.overall_let || p.overall || 'N/A';
                const pot = p.potential_let || p.potential || 'N/A';
                const isInjured = p.InjuryType && p.WeekEnd >= currentWeek;
                const weeksRemaining = isInjured ? (p.WeekEnd - currentWeek + 1) : 0;
                
                // Clean injury type (remove quotes if present)
                const injuryType = p.InjuryType ? p.InjuryType.replace(/"/g, '') : '';
                
                html += '<div class="player-card' + (isInjured ? ' injured' : '') + '">' +
                    '<div class="depth-badge">' + (p.DepthChart||'-') + '</div>' +
                    '<div class="player-name">' + (p.FirstName||'') + ' ' + (p.LastName||'') + '</div>';
                
                // Add injury badge if injured
                if (isInjured) {
                    html += '<div class="injury-badge">' +
                        '<div class="injury-type">üè• ' + injuryType + '</div>' +
                        '<div class="injury-weeks">' + weeksRemaining + ' week' + (weeksRemaining > 1 ? 's' : '') + '</div>' +
                        '</div>';
                } else {
                    html += '<div></div>'; // Empty cell to maintain grid
                }
                
                html += '<div class="player-detail"><div class="player-detail-label">Age</div><div class="player-detail-value">' + (p.Age||'-') + '</div></div>' +
                    '<div class="player-detail"><div class="player-detail-label">Height</div><div class="player-detail-value">' + (p.Height ? fmtHeight(p.Height) : '-') + '</div></div>' +
                    '<div class="player-detail"><div class="player-detail-label">Weight</div><div class="player-detail-value">' + (p.Weight||'-') + '</div></div>' +
                    '<div class="player-detail"><div class="player-detail-label">College</div><div class="player-detail-value">' + (p.College||'-') + '</div></div>' +
                    '<div class="player-stat-inline"><div class="stat-name-inline">Overall</div><div class="stat-val-inline">' + ovr + '</div></div>' +
                    '<div class="player-stat-inline"><div class="stat-name-inline">Potential</div><div class="stat-val-inline">' + pot + '</div></div>' +
                    '</div>';
            });
            html += '</div></div>';
        });
        html += '</div>';
        document.getElementById('roster-container').innerHTML = html;
    }

    function clearRoster() {
        document.getElementById('teamSelect').value = '';
        document.getElementById('team-header').innerHTML = '';
        document.getElementById('stats-container').innerHTML = '';
        document.getElementById('roster-container').innerHTML =
            '<div class="roster-container"><div class="empty-state"><h3>No team selected</h3></div></div>';
    }

    // ‚îÄ‚îÄ Standings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loadStandings() {
        const teams = query('SELECT TeamID, name FROM Teams');
        const standings = teams.map(t => {
            const wins = query('SELECT COUNT(*) as c FROM GameLog WHERE WinningTeamID=? AND TieFlag=0', [t.TeamID])[0].c;
            const losses = query('SELECT COUNT(*) as c FROM GameLog WHERE LosingTeamID=? AND TieFlag=0', [t.TeamID])[0].c;
            const ties = query('SELECT COUNT(*) as c FROM GameLog WHERE (HomeTeamID=? OR AwayTeamID=?) AND TieFlag=1', [t.TeamID,t.TeamID])[0].c;
            const pts = query(`
                SELECT 
                    SUM(CASE WHEN HomeTeamID=? THEN HomeTeamScore ELSE 0 END) +
                    SUM(CASE WHEN AwayTeamID=? THEN AwayTeamScore ELSE 0 END) as pf,
                    SUM(CASE WHEN HomeTeamID=? THEN AwayTeamScore ELSE 0 END) +
                    SUM(CASE WHEN AwayTeamID=? THEN HomeTeamScore ELSE 0 END) as pa
                FROM GameLog WHERE HomeTeamID=? OR AwayTeamID=?
            `, [t.TeamID,t.TeamID,t.TeamID,t.TeamID,t.TeamID,t.TeamID])[0];
            const pf = pts.pf || 0, pa = pts.pa || 0;
            return {name: t.name, wins, losses, ties, points_for: pf, points_against: pa, point_diff: pf-pa};
        });
        standings.sort((a,b) => b.wins - a.wins || b.point_diff - a.point_diff);

        let html = '<div class="standings-table-container"><table><thead><tr>' +
            '<th>Rank</th><th>Team</th><th>W</th><th>L</th><th>T</th><th>PF</th><th>PA</th><th>Diff</th>' +
            '</tr></thead><tbody>';
        standings.forEach((t,i) => {
            const r = i+1, rc = r<=3 ? 'rank-'+r : '';
            const diff = t.point_diff >= 0 ? '+'+t.point_diff : t.point_diff;
            const color = t.point_diff >= 0 ? '#2ecc71' : '#e74c3c';
            html += '<tr><td><span class="rank-badge '+rc+'">'+r+'</span></td>' +
                '<td><div class="team-with-logo">'+logoImg(t.name,'team-logo-small')+'<strong>'+t.name+'</strong></div></td>' +
                '<td>'+t.wins+'</td><td>'+t.losses+'</td><td>'+t.ties+'</td>' +
                '<td>'+t.points_for+'</td><td>'+t.points_against+'</td>' +
                '<td style="color:'+color+';font-weight:bold">'+diff+'</td></tr>';
        });
        document.getElementById('standings-container').innerHTML = html + '</tbody></table></div>';
    }

    // ‚îÄ‚îÄ Scores ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loadScores() {
        const scores = query(`
            SELECT g.GameID, g.SeasonID, g.HomeTeamScore, g.AwayTeamScore,
                   g.TieFlag, g.OvertimeFlag,
                   ht.name as HomeTeamName, at.name as AwayTeamName
            FROM GameLog g
            LEFT JOIN Teams ht ON g.HomeTeamID = ht.TeamID
            LEFT JOIN Teams at ON g.AwayTeamID = at.TeamID
            ORDER BY g.GameID DESC
        `);
        let html = '<div class="scores-table-container">';
        scores.forEach(g => {
            const hw = g.HomeTeamScore > g.AwayTeamScore && !g.TieFlag;
            const aw = g.AwayTeamScore > g.HomeTeamScore && !g.TieFlag;
            html += '<div class="game-card">' +
                '<div class="game-header"><div><strong>Game '+g.GameID+'</strong> ‚Äî Season '+g.SeasonID+'</div>' +
                '<div>'+(g.TieFlag?'<span class="game-badge badge-tie">TIE</span>':'')+(g.OvertimeFlag?'<span class="game-badge badge-ot">OT</span>':'')+'</div></div>' +
                '<div class="game-teams">' +
                '<div class="game-team-container" style="align-items:flex-end">'+logoImg(g.AwayTeamName,'team-logo')+
                '<div class="team-name'+(aw?' winner':'')+'">'+g.AwayTeamName+'</div>' +
                '<div class="score'+(aw?' winner':'')+'">'+g.AwayTeamScore+'</div></div>' +
                '<div class="vs">@</div>' +
                '<div class="game-team-container" style="align-items:flex-start">'+logoImg(g.HomeTeamName,'team-logo')+
                '<div class="team-name'+(hw?' winner':'')+'">'+g.HomeTeamName+'</div>' +
                '<div class="score'+(hw?' winner':'')+'">'+g.HomeTeamScore+'</div></div>' +
                '</div></div>';
        });
        document.getElementById('scores-container').innerHTML = html + '</div>';
    }

    // ‚îÄ‚îÄ Season Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loadSeasonStats() {
        allSeasonStats = query(`
            SELECT s.PlayerID, p.FirstName, p.LastName, p.Position, t.name as TeamName,
                   COUNT(DISTINCT s.GameID) as gamesPlayed,
                   SUM(s.passingAttempts) as passingAttempts, SUM(s.passingCompletions) as passingCompletions,
                   SUM(s.passingYards) as passingYards, SUM(s.passingTDs) as passingTDs, SUM(s.passingInterceptions) as passingInterceptions,
                   SUM(s.rushAttempts) as rushAttempts, SUM(s.rushYards) as rushYards, SUM(s.rushTDs) as rushTDs, SUM(s.rushFumbles) as rushFumbles,
                   SUM(s.receivingTargets) as receivingTargets, SUM(s.receivingReceptions) as receivingReceptions, SUM(s.receivingYards) as receivingYards, SUM(s.receivingTDs) as receivingTDs,
                   SUM(s.defensiveTackles) as defensiveTackles, SUM(s.defensiveSacks) as defensiveSacks, SUM(s.defensiveFumbles) as defensiveFumbles,
                   SUM(s.defensiveInterceptions) as defensiveInterceptions, SUM(s.defensivePassBreakups) as defensivePassBreakups, SUM(s.defensiveTFL) as defensiveTFL,
                   SUM(s.fgAttempt) as fgAttempt, SUM(s.fgMake) as fgMake, SUM(s.puntAttempt) as puntAttempt, SUM(s.puntYards) as puntYards
            FROM SeasonStats s
            LEFT JOIN Players p ON s.PlayerID = p.PlayerID
            LEFT JOIN Rosters r ON s.PlayerID = r.PlayerID
            LEFT JOIN Teams t ON r.TeamID = t.TeamID
            WHERE s.season = 2025
            GROUP BY s.PlayerID
        `);
        filterStatsBySkill();
    }

    function toggleSortOrder() {
        sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
        document.getElementById('sortOrderBtn').textContent = sortOrder === 'desc' ? '‚Üì Desc' : '‚Üë Asc';
        filterStatsBySkill();
    }

    const sortOptionMap = {
        passing: [['passingYards','Pass Yards'],['passingTDs','Pass TDs'],['passingAttempts','Attempts'],['passingCompletions','Completions'],['passingInterceptions','INTs']],
        rushing: [['rushYards','Rush Yards'],['rushTDs','Rush TDs'],['rushAttempts','Attempts']],
        receiving: [['receivingYards','Rec Yards'],['receivingTDs','Rec TDs'],['receivingReceptions','Receptions'],['receivingTargets','Targets']],
        defense: [['defensiveTackles','Tackles'],['defensiveSacks','Sacks'],['defensiveInterceptions','INTs'],['defensiveFumbles','Fumbles'],['defensivePassBreakups','PBUs'],['defensiveTFL','TFLs']],
        kicking: [['fgMake','FG Made'],['fgAttempt','FG Att']],
        punting: [['puntYards','Punt Yards'],['puntAttempt','Punts']]
    };

    function filterStatsBySkill() {
        const skill = document.getElementById('skillSelect').value;
        const sel = document.getElementById('sortSelect');
        const prev = sel.value;
        sel.innerHTML = '<option value="">-- Choose stat --</option>';
        (sortOptionMap[skill] || []).forEach(o => {
            const opt = document.createElement('option');
            opt.value = o[0]; opt.textContent = o[1];
            if (o[0] === prev) opt.selected = true;
            sel.appendChild(opt);
        });
        const sortBy = sel.value;

        let filtered = [];
        if (skill === 'passing') filtered = allSeasonStats.filter(s => s.Position === 'QB');
        else if (skill === 'rushing') filtered = allSeasonStats.filter(s => (s.rushAttempts||0) > 0);
        else if (skill === 'receiving') filtered = allSeasonStats.filter(s => (s.receivingTargets||0) > 0);
        else if (skill === 'defense') filtered = allSeasonStats.filter(s => ['DE','DT','LB','CB','FS','SS'].includes(s.Position));
        else if (skill === 'kicking') filtered = allSeasonStats.filter(s => s.Position === 'K');
        else if (skill === 'punting') filtered = allSeasonStats.filter(s => s.Position === 'P');

        if (sortBy) {
            filtered.sort((a,b) => sortOrder === 'desc' ? (b[sortBy]||0) - (a[sortBy]||0) : (a[sortBy]||0) - (b[sortBy]||0));
        }

        renderSeasonStats(filtered, skill);
    }

    const colMap = {
        passing: ['Att','Comp','Yards','TD','INT','Avg'],
        rushing: ['Att','Yards','Avg','TD','Fum'],
        receiving: ['Targets','Rec','Yards','Avg','TD'],
        defense: ['Tackles','Sacks','TFL','INT','Fum','PBU'],
        kicking: ['FG Made','FG Att','FG%'],
        punting: ['Punts','Yards','Avg']
    };

    function renderSeasonStats(stats, skill) {
        const c = document.getElementById('season-stats-container');
        if (!stats.length) {
            c.innerHTML = '<div class="stats-table-container"><p style="text-align:center;padding:40px;color:#999">No stats for this category</p></div>';
            return;
        }
        const cols = colMap[skill] || [];
        let html = '<div class="stats-table-container"><table><thead><tr><th>#</th><th>Player</th><th>Team</th><th>Pos</th><th>GP</th>';
        cols.forEach(col => { html += '<th>'+col+'</th>'; });
        html += '</tr></thead><tbody>';

        stats.forEach((p,i) => {
            html += '<tr><td><strong>'+(i+1)+'</strong></td>' +
                '<td><strong>'+(p.FirstName||'')+' '+(p.LastName||'')+'</strong></td>' +
                '<td>'+(p.TeamName||'N/A')+'</td><td>'+(p.Position||'')+'</td><td>'+(p.gamesPlayed||0)+'</td>';

            if (skill === 'passing') {
                const att = p.passingAttempts||0, yds = p.passingYards||0;
                html += '<td>'+att+'</td><td>'+(p.passingCompletions||0)+'</td><td>'+yds+'</td>' +
                        '<td>'+(p.passingTDs||0)+'</td><td>'+(p.passingInterceptions||0)+'</td>' +
                        '<td>'+(att > 0 ? (yds/att).toFixed(1) : '0.0')+'</td>';
            } else if (skill === 'rushing') {
                const att = p.rushAttempts||0, yds = p.rushYards||0;
                html += '<td>'+att+'</td><td>'+yds+'</td><td>'+(att > 0 ? (yds/att).toFixed(1) : '0.0')+'</td>' +
                        '<td>'+(p.rushTDs||0)+'</td><td>'+(p.rushFumbles||0)+'</td>';
            } else if (skill === 'receiving') {
                const rec = p.receivingReceptions||0, yds = p.receivingYards||0;
                html += '<td>'+(p.receivingTargets||0)+'</td><td>'+rec+'</td><td>'+yds+'</td>' +
                        '<td>'+(rec > 0 ? (yds/rec).toFixed(1) : '0.0')+'</td><td>'+(p.receivingTDs||0)+'</td>';
            } else if (skill === 'defense') {
                html += '<td>'+(p.defensiveTackles||0)+'</td><td>'+(p.defensiveSacks||0)+'</td>' +
                        '<td>'+(p.defensiveTFL||0)+'</td><td>'+(p.defensiveInterceptions||0)+'</td>' +
                        '<td>'+(p.defensiveFumbles||0)+'</td><td>'+(p.defensivePassBreakups||0)+'</td>';
            } else if (skill === 'kicking') {
                const att = p.fgAttempt||0, made = p.fgMake||0;
                html += '<td>'+made+'</td><td>'+att+'</td><td>'+(att > 0 ? ((made/att)*100).toFixed(1)+'%' : '0.0%')+'</td>';
            } else if (skill === 'punting') {
                const att = p.puntAttempt||0, yds = p.puntYards||0;
                html += '<td>'+att+'</td><td>'+yds+'</td><td>'+(att > 0 ? (yds/att).toFixed(1) : '0.0')+'</td>';
            }
            html += '</tr>';
        });
        c.innerHTML = html + '</tbody></table></div>';
    }

    // ‚îÄ‚îÄ News ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loadNews() {
        allNews = query(`
            SELECT NewsID, WeekID, SeasonID, NewsType, ProfilePicture, Media, Handle, Name, Content
            FROM NewsFeed
            ORDER BY SeasonID DESC, WeekID DESC, NewsID DESC
        `);
        filterNews();
    }

    function filterNews() {
        const filter = document.getElementById('newsFilter').value;
        const filtered = filter === 'all' ? allNews : allNews.filter(n => (n.NewsType||'').toLowerCase() === filter);
        renderNews(filtered);
    }

    function badgeClass(type) {
        const map = {report:'badge-report', tweet:'badge-tweet', injury:'badge-injury', trade:'badge-trade'};
        return map[(type||'').toLowerCase()] || 'badge-default';
    }

    function renderNews(news) {
        const c = document.getElementById('news-container');
        if (!news.length) {
            c.innerHTML = '<div style="background:white;padding:60px 20px;border-radius:16px;text-align:center;color:#94a3b8"><div style="font-size:64px">üì∞</div><h3>No news yet</h3></div>';
            return;
        }
        const cards = news.map(item => {
            const typeLabel = item.NewsType ? item.NewsType.charAt(0).toUpperCase() + item.NewsType.slice(1).toLowerCase() : 'News';
            const meta = (item.SeasonID ? 'Season ' + item.SeasonID : '') + (item.WeekID ? ' ¬∑ Wk ' + item.WeekID : '');
            const initials = getInitials(item.Name);

            const avatar = item.ProfilePicture
                ? '<img src="Pictures/'+item.ProfilePicture+'.png" alt="'+(item.Name||'')+'" class="news-avatar" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'">'+
                  '<div class="news-avatar-placeholder" style="display:none">'+initials+'</div>'
                : '<div class="news-avatar-placeholder">'+initials+'</div>';

            const mediaImg = (item.Media && item.Media !== 'null')
                ? '<img src="Pictures/'+item.Media+'.png" alt="media" class="news-image" onerror="this.style.display=\'none\'">'
                : '';

            return '<div class="news-card"><div class="news-card-inner"><div>'+avatar+'</div>' +
                '<div><div class="news-header">' +
                '<span class="news-name">'+(item.Name||'WFL Reporter')+'</span>' +
                '<span class="news-handle">'+(item.Handle||'')+'</span>' +
                '<span class="news-badge '+badgeClass(item.NewsType)+'">'+typeLabel+'</span>' +
                '<span class="news-meta">'+meta+'</span></div>' +
                '<div class="news-content">'+(item.Content||'')+'</div>'+mediaImg+
                '<div class="news-footer">' +
                '<span>üí¨ Reply</span><span>üîÅ Repost</span><span>‚ù§Ô∏è Like</span><span>üì§ Share</span>' +
                '</div></div></div></div>';
        }).join('');
        c.innerHTML = '<div class="news-feed">'+cards+'</div>';
    }

    // ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.addEventListener('DOMContentLoaded', initDatabase);
</script>
</body>
</html>
